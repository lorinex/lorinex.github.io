---
date: 2024-01-21 15:23:20
title: 3 数据链路层
categories:
  - 计算机网络
---

## 数据链路层的功能

数据链路层的功能：

1. 向网络层提供一个定义良好的服务接口。
2. 处理传输错误。
3. 调节数据流，确保慢速的接收方不会被快速的发送方淹没。

为了实现这些目标，数据链路层从网络层获得数据包，然后将这些数据包封装成帧 (frame) 以便传输。每个帧包含一个帧头、一个有效载荷（用于存放数据包）以及一个帧尾。

基本术语：

1. 结点(node)：

   网络中的主机（host）和路由器（router）称为结点

2. 链路（Link）

   两个结点之间的点到点的线路段

3. 数据链路（Data Link）

   协议+链路，在不可靠的物理链路上实现可靠的传输

4. 端到端（end to end）

   从源结点（source node）到目的结点 （ destinationnode）的通信路径（path），可能由多个链路组成

提供给网络层的服务：

无确认的无连接服务：是指源机器向目标机器发送独立的帧，目标机器并不对这些帧进行确认。

有确认的无连接服务：当向网络层提供这种服务时，数据链路层仍然没有使用逻辑连接，但其发送的每一帧都需要单独确认。

面向连接的服务：采用这种服务，源机器和目标机器在传输任何数据之前要建立一个连接。连接上发送的每一帧都被编号，数据链路层确保发出的每个帧都会真正被接收方收到。它还保证每个帧只被接收一次，并且所有的帧都将按正确的顺序被接收。

数据链路层使用的信道

1. 点对点信道，使用一对一的通信方式。 PPP 协议则是目前使用报广泛的点对点协议。 
2. 广播信道，这种信道上连接的主机很多，使用一对多的广播通信方式。采用共享广播信 道的有线局域网普遍使用 CSMA/CD 协议，而无线局域网则使用 CSMA/CA 协议。



## 封装成帧与透明传输

**透明传输**：在数据链路层传输时，所传输的数据在数据链路层没有任何的阻挡，接收方所收到的数据和发送方发送的数据没有任何差别，也就是说，**数据链路层对其传输的数据帧是完全透明的。**

**封装成帧**是指在一段数据的前后分别添加首部和尾部构成帧。

帧是数据链路层的数据传送单元。

帧长=帧的数据部分长度+首部和尾部的长度。

首部和尾部中含有很多控制信息，它们的一个重要作用是确定帧的界限，即**帧定界**。

接收方能从接收到的二进制比特流中区分出帧的 起始与终止，即**帧同步**。

### 字符计数法Character Count

利用头部中的一个字段来标识该帧中的字符数。

![img](https://picture2023-1309715649.cos.ap-beijing.myqcloud.com/img/2021-07-21-10-47-55-9uynXC.png)

### 字节填充法Byte Stuffing

让每个用一些特殊的字节作为开始和结朿。这些特殊字节通常都相同，称为标志字节 (flag byte)，作为帧的起始和结束分界符。

![img](https://picture2023-1309715649.cos.ap-beijing.myqcloud.com/img/2021-07-21-10-47-55-09lAvz.png)

### 零比特填充法Bit Stuffing

每个帧的开始和结束由一个特殊的比特模式，01111110 或十六进制 0x7E 标记。这种模式是一个标志字节。每当发送方的数据链路层在数据中遇到连续五个 1，它便自动在输出的比特流中填入一个比特 0。这种比特填充类似于字节填充，在数据字段的标志字节之前插入一个转义字节到出境字符流中。

### 违规编码法Physical Layer Coding Violations

在物理层进行比特编码时，常采用违规编码法。例如，曼彻斯特编码方法将数据比特 “1" 编码成“高－低“电平对，将数据比特 ”O" 编码成“低－高“电平对，而“高－高“电平对和“低 －低“电平对在数据比特中是违规的（即没有采用），因此可借用这些违规编码序列来定界帧的起始和终止。局域网 IEEE 802 标准就采用了这种方法。违规编码法不采用任何填充技术便能实现数 据的透明传输，但只适用千采用冗余编码的特殊编码环境。

## 差错检测和纠正

通常利用编码技术进行差错控制，主要有两类：自动重传请求 (ARQ)和前向纠错(FEC) 。

在 ARQ方式中，当接收方检测到差错时，就设法通知发送方重发，直到收到正确的数据为止。在 FEC 方式中，接收方不但能发现差错，而且能确定错误的位置并加以纠正。因此，差错控制又可分为检错编码和纠错编码。

### 检错编码

#### 奇偶校验码

缺点：只能检验奇数位出错情况

1. 奇检验码：附加一个检验位后，码长为 n 的码字中 1 的个数为奇数。
2. 偶检验码：附加一个检验位后，码长为 n 的码字中 1 的个数为偶数。

#### 循环冗余码CRC

（1）发送方：待校验数据补充r个0之后，对生成多项式进行模2除法，余数（r位）即为校验信息

（2）接收方：待校验数据和校验信息一起，对生成多项式进行模2除法，余数不为0即认为有错

![image-20240121164309560](https://picture2023-1309715649.cos.ap-beijing.myqcloud.com/img/image-20240121164309560.png)

CRC 的性能：

- **所有的一位错误都将被检测到**
- 可以捕捉到**所有包含奇数个位**变反的错误情形
- 带 r 个校验位的多项式编码可以检测到所有**长度小于等于 r 的突发错误**
- 如果突发错误的长度为 r+1，这样一个不正确的帧被当做有效帧接收的概率是$\frac 1 {2^{r-1}}$
- 同样可以证明，当一个长度大于 r+1 位的突发错误发生时，或者几个短突发错误发生时，一个坏帧被当做有效帧通过检测的概率为$\frac 1 {2^{r}}$

### 纠错编码

最常见的纠错编码是海明码。

![image-20240121164632811](https://picture2023-1309715649.cos.ap-beijing.myqcloud.com/img/image-20240121164632811.png)

![image-20240121164709496](https://picture2023-1309715649.cos.ap-beijing.myqcloud.com/img/image-20240121164709496.png)

## 流量控制和可靠传输机制

### 乌托邦式的单工协议

单工协议即数据只能单向传输。这个协议假设信道永远不会丢失或损坏帧，接收方的处理能力足够快，缓冲区足够大。发送程序无限循环，接受程序响应事件，协议1中不包含流量控制和纠错功能。

### Stop-and-Wait Protocol

#### 无错信道上的单工停等协议

发送方的速度如果过快，接收方会被淹没，除了增强接收方的处理能力，可以让接收方给发送方发送反馈，发送方收到后才可以发送下一帧。发送程序无限循环并等待接收方确认，接受程序响应事件后发送确认帧。

#### 有错信道上的单工停等协议

有错信道上传输数据需要增加校验，接收方仅在数据正确时发送确认帧。但在确认帧丢失的情况下（超时），发送方将重发。接收方难以判断帧是重发还是新发，因此帧前加上序号以区分。重复的帧也会收到确认帧，以便发送方决策。

#### 超时重传

1. 分组丢失：发送方发送分组，接收方没有收到分组，那么接收方不会发出确认，只要发送方过一段时间没有收到确认，就认为刚才的分组丢了，那么发送方就会再次发送。
2. 确认丢失：发送方发送成功，接收方接收成功，确认分组也被发送，但是分组丢失，那么到了等待时间，发送方没有收到确认，又会发送分组过去，此时接收方前面已经收到了分组，那么此时接收方要做的事就是:丢弃分组,重新发送确认。
3. 传送延迟：发送方发送成功，接收方接收成功，确认分组也被发送，没有丢失，但是由于传输太慢，等到了发送方设置的时间，发送方又会重新发送分组，此时接收方要做的事情：丢弃分组，重新发送确认.。发送方如果收到两个或者多个确认，就停止发送，丢弃其他确认。

#### 差错控制

ARQ（自动请求重传）实现差错控制

- 如果正确的接收，那么接受方会发送一个ACK帧给发送方
- 如果发送方没有收到接受方回复的ACK帧，那么发送方会设置计时器并重新发送传输帧

为了确保正确性，必须对框架和ACK进行编号

- 接收机需要区分重传（由于丢失ACK或提前定时器）和新帧，对于停等协议，2个数字（使用1位）就足够了。

#### 信道利用率

![image-20240121214056171](https://picture2023-1309715649.cos.ap-beijing.myqcloud.com/img/image-20240121214056171.png)
$$
\alpha = \frac {t_{prop}} {t_{frame}} = \frac {Distance/Speed Of Signal} {Frame Size/Bit rate}
$$

$$
U=\frac {t_{frame}} {2t_{prop}+t_{frame}}=\frac 1 {2\alpha +1}
$$

### Sliding Window Protocol

#### 滑动窗口的概念

所有滑动窗口协议的本质是在任何时刻发送方总是维持着一组序号，分别对应于允许它发送的帧。我们称这些帧落在发送窗口 (sending window) 内。类似地，接收方也维持着一个接收窗口 (receiving window)，对应于一组允许它接受的帧。

**发送方窗口内的序号代表了那些可以被发送的帧，或者那些已经被发送但还没有被确认的帧**。任何时候当有新的数据包从网络层到来时，它被赋予窗口中的下一个最高序号，并且窗口的上边界前移一格。当收到一个确认时，窗口的下边界也前移一格。按照这种方法发送窗口持续地维持了一系列未被确认的帧。

**接收方数据链路层的窗口对应于它可以接受的帧**。任何落在窗口内的帧被放入接收方的缓冲区。当收到一个帧，而且其序号等于窗口下边界时，接收方将它传递给网络层，并将整个窗口向前移动 1 个位置。任何落在窗口外面的帧都将被丢弃。在所有情况下，接收方都要生成一个确认并返回给发送方，以便发送方知道该如何处理。

#### 滑动窗口协议的特点

- 只有接受窗口向前移动的时候，发送窗口才会向前移动
- 从滑动窗口的概念来看，停止等待协议、回退N协议和选择重传协议只不过是发送窗口和接受窗口的大小不同
  - 停止等待协议：发送窗口和接受窗口大小都是1
  - 后退N协议:发送窗口>1,接收窗口大小为1
  - 选择重传协议:发送窗口>1,接受窗口大小>1
- 当接收窗口大小为1的时候可以保证有序的被接收
- 数据链路层中，传输过程中滑动窗口的大小是固定的

#### 可靠的传输机制

- 捎带确认(piggy backing)：数据帧携带一个ACK帧
- 超时重传：在发送某个数据帧之后，就开启一个计时器，开始计时，一旦超过某段时间还没有收到确认帧，就重新发送该数据帧

自动重传请求ARQ：接受方请求发送方重新发送出错的数据帧来恢复出错的帧，传统的自动重传分三种

- 停止等待ARQ
- 后退ARQ
- 选择性重传ARQ
  窗口开的够大的时候，帧在线路上可以连续的流动，因此又称连续的ARQ协议

#### 一位滑动窗口协议

发送窗口=接收窗口=1，其实就是停等协议。

![img](https://picture2023-1309715649.cos.ap-beijing.myqcloud.com/img/2021-07-21-10-48-05-bbOgga.png)

#### 回退N帧协议GBN

- 发送窗口的大小>1，接收窗口的大小=1
- 接收端发现某一帧发生差错时，直接丢弃所有后续的帧，对丢弃帧不发送确认
- 数据链路层除了接收应该递交给网络层的下一帧之外，拒绝接收其它任何帧
- 发送方最终会超时，将按顺序重传所有未被确认的帧，即从最初受损或丢失的那一帧开始
- 接收端接收帧的顺序和发送端发出帧的顺序相同

![img](https://picture2023-1309715649.cos.ap-beijing.myqcloud.com/img/1734701-20191113143205596-1020968708.png)

**窗口大小的选择**

- 用n表示序号字段长度；$2^n$表示发送端可发送帧的序号个数
- 发送窗口尺寸w应为$2^n-1$
- 任何时候，可以发送的帧的最大个数不能等同于序号空间的大小。对回退 n 协议，可发送的帧最多为 MAX_SEQ 个，即使存在 MAX_SEQ+1 个不同的序号（分别为 0、1、2、...MAX_SEQ)。

**适用情况**

- 回退n帧协议，如果错误率较低时，工作的很好
- 但错误率较高时，就会浪费大量的带宽在重传上

**累计确认**

当 n 号帧的确认到达，n-1 号帧、n-2 号帧等都会自动被确认。这种类型的确认称为累计确认 (cumulative acknowledgement)。

**计时器**

因为协议 5 有多个未被确认的帧，所以逻辑上它需要多个计时器，即每一个未被确认的帧都需要一个计时器

#### 选择重传协议SR

- 接收方的数据链路层存储坏帧之后的所有正确的帧，当发送方得知某个帧出错时，只是重传此坏帧，而不是所有的后继帧
- 在这个协议中，发送方和接收方都维持一个可接收序列号的窗口
- 接收窗口的大小>1，并为窗口中的每个序列号都提供一个缓冲区，每个缓冲区用一位判断其是否为空
- 当某一帧到达时，接收方检查其序列号，看其是否落在窗口内
- 如果落在窗口内且从未接收过，就接收并存储
- 接收到的此帧保存在数据链路层，而不交给网络层，直到比它序列号小的所有帧都按次序已交给了网络层，此帧才能提交给网络层

![img](https://picture2023-1309715649.cos.ap-beijing.myqcloud.com/img/1734701-20191113173906867-2062364742.png)

**选择重传协议的窗口大小**

窗口大小应为

`Ws+Wr<=2^n | Ws>=Wr | Ws,Wr<=2^(n-1) `

一般情况下发送窗口和接收窗口都取$2^{n-1}$

这个问题的本质在于：当接收方向前移动它的窗口后，新的有效序号范围与老的序号范围有重叠。因此，后续的一批帧可能是重复的帧（如果所有的确认都丢失了），也可能是新的帧（如果所有的确认都接收到了）。可怜的接收方根本无法区分这两种情形。

解决这个难题的办法是确保接收方向前移动窗口之后，新窗口与老窗口的序号没有重叠。为了保证没有重叠，窗口的最大尺寸应该不超过序号空间的一半，

无论如何，接收方不可能接受序号低于窗口下界的帧，也不可能接受序号高于窗口上界的帧。因此，所需要的缓冲区的数量等于窗口的大小，而不是序号的范围。

出于同样的原因，需要的计时器数量等同于缓冲区的数量，而不是序号空间的大小。

实际上，每个缓冲区都有一个相关联的计时器。当计时器超时，缓冲区的内容就要被重传

**NAK**

当接收方有理由怀疑出现了错误时，它就给发送方返回一个否定确认 (NAK) 帧。这样的帧实际上是一个重传请求，在 NAK 中指定了要重传的帧。在两种情况下，接收方要特别注意：接收到一个受损的帧，或者到达的帧并非是自己所期望的（可能出现丢帧错误）。为了避免多次请求重传同一个丢失帧，接收方应该记录下对于某一帧是否已经发送过 NAK。

### 信道利用率/帧序号计算

1. 信道利用率

- 帧发送时间$$t_f$$、单向传播时延$$t_p$$、发送窗口大小$$W_T$$
  - $$\alpha=\frac{t_p}{t_f}$$
  - $$t_f=\frac{帧长}{信道速率}$$
- 信道利用率$$U=\frac{W_T}{1+2a}=\frac{W_T*t_f}{t_f+2*t_p+t_{确认}（一般忽略）}$$
  - U=100%  $$W\geq1+2a$$
  - U<100%  $$W<1+2a$$
- 采用捎带应答时，信道利用率$$U=\frac{W_T}{2+2a}$$
  - U=100%  $$W\geq2+2a$$
  - U<100%  $$W<2+2a$$
- 信道利用率$$U=\frac{L_1}{L_1+L_2+2×t×v}$$
  - L1:发送帧长   L2:确认帧长  t:单向传播时延   v:传输速率

2. 帧序号计算

- 第一个总用时$$t_总=t_f+2*t_p+t_{确认}$$
- 计算可发多少个
  - $$x=\frac{t_总}{t}$$
- 计算最小帧序号 n
  - GBN:$$x<2^n-1$$
  - SR:$$x<2^{n-1}$$

## 介质访问控制



## 局域网



## 广域网



## 数据链路层协议实例

### PPP

### HDLC



## 数据链路层设备

