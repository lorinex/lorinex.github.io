---
title: 7 File-System
date: 2023-12-30 12:45:59
tags: 
categories:
  - OS
---

#  File-System

## File Concept

连续的逻辑地址空间指的是操作系统为用户提供了统一的逻辑视图来访问存储设备上的信息。文件是一个命名的、相关的信息的集合，这些信息被记录在次级存储设备上。文件是逻辑次级存储的最小分配单元。常见的文件类型包括程序源代码、目标代码和数据文件(数字、字符、二进制)。文件可以是自由格式的，也可以是格式固定的。文件的信息由其创建者定义。文件通过其名称进行命名，并可以通过名称进行访问，是独立的。

### File Attributes

文件属性包括：
- 名称(Name): 仅以人类可读的形式保存的信息。
- 标识符(Identifier): 在系统中唯一标识文件的数字，非人类可读的文件名。 
- 类型(Type): 用于支持不同类型的系统。
- 位置(Location): 设备上文件的位置指针。
- 大小(Size): 文件当前的大小。
- 保护(Protection): 访问控制信息，控制谁可以进行读、写、执行操作。
- 时间、日期和用户标识(Time, date, and user identification): 用于保护、安全性和使用监控的数据。

这些文件属性保存在目录结构中，该结构由维护在磁盘上的目录条目组成。目录条目由文件名和唯一的id组成，id反过来指向其他文件属性。

### File Operations

文件是一个抽象数据类型。文件操作的最小集合包括：
- Create - 找到空间，在目录中为文件创建条目。
- Write - 文件名，要写入的信息，写入指针。 
- Read - 文件名，内存中的位置，读取指针。每个进程有一个当前文件位置指针。
- Reposition within file - 文件seek，不需要I/O。
- Delete - 文件名，释放文件空间，删除目录条目。
- Truncate - 将长度重置为0，释放文件空间。
这些基本操作可以组合起来执行其他文件操作，比如复制。大多数文件操作涉及搜索目录以查找与文件名相关联的条目。

Open-file table是一个内核数据结构，包含有关所有打开文件的的信息。
Open(Fi)操作会在磁盘上的目录结构中查找Fi的条目，并将该条目的内容移动到打开文件表中。它还会返回打开文件表中该条目的一个指针，并接受访问模式信息，如创建、只读、读写、只追加等。
Close(Fi)操作会将打开文件表中Fi的条目的内容移动到磁盘上的目录结构中。

文件共享意味着多个进程和应用程序可以同时打开同一个文件。
为此，需要两个级别的内部表：

- 进程打开文件表：每个进程都有一个进程打开文件表，用于跟踪该进程打开的所有文件以及进程对文件的使用信息，如当前文件指针、访问权限、计费信息等。
- 系统打开文件表：包含进程无关的信息，如文件在磁盘上的位置、访问日期、文件大小等。每个进程打开文件表的条目都指向一个系统打开文件表的条目。
这样，进程可以独立地使用进程打开文件表，而系统可以使用系统打开文件表来维护进程无关的信息。

![image-20231230161451023](https://picture2023-1309715649.cos.ap-beijing.myqcloud.com/img/image-20231230161451023.png)

### Open File Locking

文件锁允许一个进程锁定文件，防止其他进程访问它。
一些操作系统和文件系统提供文件锁，它类似读写锁，包括共享锁和独占锁。共享锁允许多个进程同时获取，独占锁类似写锁，只允许一个进程获取。
文件锁可以调解进程对文件的访问。操作系统可以提供强制或建议的文件锁机制。强制机制根据持有的锁和请求的锁来拒绝访问，而建议机制允许进程查看锁的状态并决定如何操作。

### File types

操作系统是否应该识别并支持文件类型是一个常见的问题。实现文件类型的常见技术是将类型作为文件名的一部分。文件名被分割成两部分：文件名和扩展名，以点字符分隔。系统使用扩展名来表示文件的类型和可以对该文件进行的操作类型。应用程序也使用扩展名来表示它们感兴趣的文件类型。一些操作系统，每个文件都有一个类型和创作者属性，包含创建该文件的应用程序的名称。在UNIX系统中，一些文件在开头存储一个魔法数字，以大致表示文件的类型。

### File Structure

文件结构可以分为三种：
- 无结构 - 顺序的字符串或字节
- 简单记录结构 - 行、固定长度、可变长度
- 复杂结构 - 格式化文档、可重定位加载文件

操作系统和程序都可以决定文件的内部结构。

### Internal file structure

逻辑结构分为两类：
- 文本文件：一系列8位字节
- 记录文件：一系列固定或可变长度的记录

逻辑地址包括文件起始位置的偏移量和逻辑记录号。
物理结构是一组磁盘块。基本I/O函数以块为单位操作。
逻辑地址到物理地址的映射包括逻辑块号、物理磁盘块号和块内偏移量。
内部碎片化是由于逻辑记录大小、物理块大小和打包技术决定的逻辑记录数与物理块数之间的差异。磁盘空间总是以块为单位分配的。

## Access Methods

文件组织方式主要根据以下几个标准进行分类：

1. 反映不同的文件结构 - 不同的存储和处理数据的方式。
2. 快速访问 - 单记录访问时需要快速访问，而在批处理模式下不需要。
3. 更新方便性 - CD-ROM上的文件不需要更新，所以这不需要考虑。 
4. 存储经济性 - 数据冗余度最小化，冗余度可以用来加速访问，如索引。
5. 维护简单性 - 可靠性。
    根据这些标准，文件组织方式主要分为：
6. 堆积文件(Pile File) 
7. 顺序文件(Sequential File)
8. 索引顺序文件(Indexed Sequential File)
9. 索引文件(Indexed File)
10. 直接文件(Direct File，或散列文件(Hashed File))


顺序访问方式包括：

- 读取下一个记录
- 写入下一个记录
- 重置
- 重写，最后一次写入后不再读取

直接访问方式包括：
- 读取(n)
- 写入(n)
- 定位(n)
- 读取下一个记录，写入下一个记录
- 重写(n)
n为相对块号，第一个为0。
直接访问方式可以模拟顺序访问。

其他访问方式可以建立在直接访问方式之上，通常涉及为文件创建索引。索引可以保存在内存中，以快速确定要操作的数据的位置。如果索引太大，可以使用二级或多级索引文件。索引文件和相对文件的区别在于，索引文件使用索引来定位数据，而相对文件直接使用文件中的偏移量来定位数据。

## Directory Structure

每个系统中的磁盘至少包含一个分区。有些系统允许分区的大小大于磁盘，以便将磁盘组合成一个逻辑结构。
磁盘或分区可以以原始状态使用，例如交换空间。也可以格式化一个文件系统。

1. 包含文件系统的实体被称为卷(volume)。
2. 每个卷包含的文件系统也在设备目录或卷表目(volume table of contents)中跟踪该文件系统信息。
3. 目录中包含文件名、文件类型、文件位置等信息。
4. 磁盘或分区可以通过RAID(Redundant Arrays of Independent Drives)来防止故障。

目录结构可以看作是一个符号表，它将文件名转换成目录项(directory entry)。
目录结构为文件名和文件本身提供了映射。
目录结构本身是由操作系统拥有的一个文件。
目录结构和文件都存储在磁盘上。

### Single-Level Directory

### 文件系统的基本结构
- **所有文件都包含在同一个目录中**：这意味着文件系统没有使用子目录或分层结构，所有文件都存储在一个共同的位置。

- 文件的索引方式
  - **文件列表，每个文件一个条目**：这种方式下，系统会维护一个列表，列表中每个条目代表一个文件。这有点类似于目录，其中每个文件都有对应的条目。
  - **顺序文件，以文件名作为关键字**：这里的顺序文件可能指的是索引文件，它根据文件名（作为关键字）来组织文件，允许按文件名顺序访问文件。

- 遇到的问题
  - **命名问题**
    - **文件必须有唯一的名称**：在这样的系统中，由于所有文件都在同一个目录下，因此每个文件的名称必须是唯一的，以避免混淆。
    - **文件名的长度**：文件名的长度可能受限，这可能影响到如何命名文件和组织数据。
  - **分组问题**：这可能指的是如何有效地将文件分组以便管理，尤其是当所有文件都在一个目录下时。在没有子目录或分类的情况下，组织和检索文件可能会变得更加困难。
### Two-Level Directory

这种文件系统结构设计用来解决单级目录系统中文件命名冲突和文件组织问题。

**特点**
1. **为每个用户创建单独的目录**：在双级目录系统中，每个用户都有自己的目录，这有助于隔离不同用户的文件。
2. **主文件目录和用户文件目录**：
   - **主文件目录**：包含每个用户的条目，这些条目可以通过用户名或账号进行索引。它提供了用户目录的地址和访问控制信息。
   - **用户文件目录**：每个用户都有一个自己的文件目录，这个目录是该用户文件的简单列表。不同用户可以有同名的文件，因为它们存储在各自的目录中。

**优势**
- **高效的搜索**：由于文件被组织在各自的用户目录中，搜索特定用户的文件变得更加高效。
  

**限制**
- **没有分组能力**：这种系统不支持跨用户的文件分组，每个用户的文件都被限制在自己的目录中。

**文件共享**
- **路径名**：由用户名和文件名定义。例如，如果一个用户想要访问另一个用户的文件，他们可能需要使用特定的路径名。
- **特殊的用户目录**：包含系统文件。这可能是为了系统管理而设置的，不同于普通用户的目录。
- **搜索路径**：是指系统搜索文件时遍历的目录序列。这可以帮助系统决定在哪些目录中查找文件。

### Tree-Structured Directories

这是一种常见的目录结构，其中每个文件都有一个独特的路径名。

#### 特点
1. **允许用户创建自己的子目录**：用户可以组织文件，将它们放在不同的子目录中。
2. **每个用户目录可能包含一个或多个子目录和文件作为条目**。
3. **所有目录具有相同的内部格式**。
4. **目录条目中的一个位用于定义条目是文件（0）还是子目录（1）**。

#### 优势
- **高效搜索**：由于其树形结构，可以快速定位文件和目录。
- **命名方便**：每个文件的路径名是唯一的，方便用户识别和访问。
- **分组能力**：用户可以通过创建子目录来有效地组织和管理文件。

#### 当前目录（工作目录）
- **在会计文件中，存储了指向用户初始目录的指针或名称**。该信息被复制到该用户的本地变量中。
- **创建新文件默认在当前目录中进行**。
- **删除文件**：使用命令 `rm <文件名>`。
- **更改当前目录**：使用命令 `cd /路径`。可以使用绝对或相对路径名。

#### 创建新的子目录
- 在当前目录下创建新的子目录，使用命令 `mkdir <目录名>`。
- 例如，在当前目录 `/mail` 下，创建一个名为 `count` 的新目录：`mkdir count`。

#### 删除子目录
- **删除空目录**：在某些系统（如MS-DOS）中，只能删除空目录。
- **删除所有文件和子目录**：在某些系统（如UNIX）中，可以删除包含所有文件和子目录的目录。

### Acyclic-Graph Directories

这种目录结构允许共享子目录和文件，是一种较为复杂的文件系统结构。

#### 特点
1. **相同的文件或子目录可以出现在两个不同的目录中**。
2. **共享的文件/目录与文件/目录的两份拷贝不同**。

#### 实现共享文件和子目录的方式
1. **创建一个新的目录条目，称为链接**（例如UNIX中的链接）：这是指向另一个文件或子目录的指针。
   - 路径名：目录条目被标记为链接。
   - 解析链接：遵循指针定位文件。
   - 链接与原始目录条目明显不同。
2. **在所有共享目录中复制有关共享文件的所有信息**：
   - 两个条目相同且等价。
   - 原始文件和副本无法区分。
   - 问题：修改文件时如何保持一致性？

#### 问题
1. **一个文件可能有多个绝对路径名**：不同的文件名可能指向同一个文件（别名问题）。
2. **遍历整个文件系统**：累计所有文件的统计信息，将所有文件复制到备份存储中。
3. **共享文件的删除**：
   - 删除任何人删除的文件时出现悬挂指针（dangling pointers）。
   - 例如，如果字典删除了计数➢链接，删除链接不会影响原始文件。
   - 删除文件条目，留下悬挂的链接。
   - 文件引用列表，反向指针。

#### 删除共享文件的问题（续）
- **保留文件直到删除了对它的所有引用**：
  - 解决方案：文件引用列表、文件引用计数、反向指针，以便我们可以删除所有指针。
  - 可变大小记录可能是一个问题。

### General Graph Directory

与无环图目录（Acyclic-Graph Directory）相比，通用图目录允许目录结构中存在循环（cycles），这意味着目录可以直接或间接地引用自身。

#### 优势
- **无环图的主要优势**是遍历图的算法相对简单。例如，可以避免对共享子目录的重复搜索，也更容易确定何时没有更多对文件的引用。

#### 问题
- **设计不良的算法可能导致无限循环**，不断地在循环中搜索而永远不会结束。

#### 文件删除的判定
1. **在无环图目录结构中**，当引用计数为0时可以删除文件。
2. **在通用图目录结构中**，由于存在循环，即使无法再引用目录或文件，引用计数可能不为0。
   - 这种异常情况源于自引用的可能性（即循环）。
   - 解决方案：使用垃圾收集。
     - 第一遍：遍历整个文件系统，标记所有可以访问的内容。
     - 第二遍：收集所有未标记的内容到自由空间列表中。

#### 避免循环的方法
1. **仅允许链接到文件而非子目录**：这样可以保证没有循环。
2. **在添加新链接时使用循环检测算法**来确定是否可行。但这种方法非常昂贵，尤其是当图在磁盘存储上时。
3. **更简单的算法**：在目录遍历期间绕过链接。

## File System Mounting

1. 文件系统必须挂载后才能被访问。
2. 挂载过程包括：操作系统被提供设备名称和挂载点(mount point) - 文件结构中用于挂载文件系统的位置。
3. 操作系统通过设备驱动程序读取设备目录并验证目录具有期望的格式，来验证设备包含有效的文件系统。
4. 操作系统在目录结构中记录文件系统已挂载在指定的挂载点。

系统通过语义(semantics)来明确功能：
- 可能不允许在包含文件的目录上挂载文件系统。
- 可能使挂载的文件系统在该目录上可用，直到卸载文件系统才会遮挡该目录中现有的文件。
- 可能允许同一文件系统在不同的挂载点上重复挂载。 
- 可能只允许每个文件系统挂载一次。

## File Sharing

多用户系统中共享文件是必要的。文件和目录的共享可以通过保护机制来实现。多用户系统需要更多的文件和目录属性，包括文件/目录所有者、文件/目录用户、访问权限等。在多用户系统中，用户ID可以识别用户，允许为每个用户设置权限和保护。组ID可以让用户属于组，允许组访问权限。文件/目录的所有者和组可以设置访问权限。

### Remote File Systems

远程文件系统使用网络允许不同系统之间的文件系统访问。 主要有三种方法：
通过像FTP这样的程序手动传输文件，适用于匿名和认证访问。
使用分布式文件系统(DFS)，远程目录对本地机器可见，机器间集成更紧密。
通过WWW自动访问，需要浏览器，使用匿名文件交换。
云计算正在被使用。

### Failure Modes

所有文件系统都有故障模式。本地文件系统故障的原因包括磁盘故障、磁盘控制器故障、电缆故障、主机适配器故障、目录结构或其他非用户数据的损坏、用户或系统管理员的错误。远程文件系统增加了新的故障模式，例如网络故障、服务器故障。从故障中恢复可能需要涉及每个远程请求的状态信息。如果服务器和客户端都维护它们当前的活动和打开的文件的知识，那么它们就可以无缝地从故障中恢复。无状态协议像NFS V3将所有信息包含在每项请求中，这使得恢复很容易，但安全性较低。在NFS V4中，它被设计成有状态的，以证明其安全性、性能和功能。

### Consistency Semantics

一致性语义(Consistency semantics)规定了多个用户如何同时访问共享文件。它指定了一个用户对数据的修改何时对其他用户可见。它类似于第6章中的进程同步算法，但由于磁盘I/O和网络延迟(对于远程文件系统)，通常比较简单。UFS(Unix文件系统)实现了以下一致性语义：
- 每个文件关联到单个物理映像。
- 对同一打开文件的其他用户的写入立即可见。
- 共享文件指针以允许多个用户并发地读取和写入。

一致性语义(Consistency semantics)规定了多个用户如何同时访问共享文件。
- AFS(Andrew File System)实现了复杂的远程文件共享语义：服务器记录客户端的行为，并保留客户端缓存的文件信息。当客户端更改文件时，服务器使用回调承诺技术通知其他客户端。只有在文件关闭后，写入才对会话可见。
- 不可变的共享文件，由其创建者声明为只读的。文件名不能重复，内容不能更改。

## Protection

可靠性涉及文件副本的备份，保护涉及对文件的访问控制，文件所有者/创建者应该能够控制对文件可以进行什么操作以及由谁进行操作。文件访问类型包括读取、写入、执行、追加、删除、列出等。

### Access control

**访问模式：读、写、执行**

- **读（Read, R）**：查看文件内容的权限。
- **写（Write, W）**：修改或删除文件的权限。
- **执行（Execute, X）**：运行文件的权限，对于脚本或程序尤其重要。

**取决于用户的身份**

根据用户的身份，访问权限可能会有所不同。这通常通过以下方式管理：

- **访问控制列表（Access-Control List, ACL）**：一种表格，将每个文件与特定用户关联，并定义每个用户拥有的访问类型（读、写、执行）。

**三类用户**

1. **拥有者（Owner）**：创建文件的用户。通常拥有最多的权限。
2. **群组（Group）**：一组需要类似访问权限的共享文件的用户。
3. **普通用户（Universe/Public）**：系统中的所有其他用户。

**访问控制信息**

- **用户访问**：读写执行（RWX，二进制表示为111，十进制表示为7）
- **群组访问**：读写（RW，二进制表示为110，十进制表示为6）
- **公共访问**：执行（X，二进制表示为001，十进制表示为1）

**权限控制的优势与问题**

- **优势**：增强安全性，确保只有授权用户才能访问特定的文件或目录。
- **问题**：可能导致配置复杂，如果不正确设置，可能会不慎阻止合法用户的访问或允许非授权访问。

**群组的创建和修改**

- 只有管理员或超级用户（superuser）能创建和修改群组。
- 管理员可以创建一个具有唯一名称的群组，比如G，并向群组中添加用户。
- 对于特定的文件（比如“game”）或子目录，可以定义适当的访问权限。

**更改用户的访问方法**

例如，使用chmod命令更改文件权限：
- `chmod G +w o=x file` 表示给群组G增加写权限，给其他用户（public）设置执行权限。
- `chgrp G game` 表示将文件“game”关联到群组G。

# File System Implementation

## File System Structure

### 文件定义
- **文件**：是相关信息的集合，是逻辑存储单元。它可以包含文本、图像、程序或其他数据类型。

### 磁盘特性
- **磁盘可就地写入**：即在磁盘上直接修改数据，而无需先移动数据。
- **磁盘可直接访问任意给定的信息块**：这意味着可以高效地检索和存储数据。
- **内存与磁盘间的I/O传输以块为单位**：数据在内存和磁盘之间以块的形式进行传输。

### 文件系统位置
- 文件系统位于**次级存储（如磁盘）**上，它提供了用户对存储的接口，将逻辑地址映射到物理地址。

### 功能
- **提供有效且方便的磁盘访问**：允许数据被轻松存储、定位和检索。

### 文件系统结构
1. **主要设计问题**
   - **用户界面**：涉及定义文件及其属性、文件操作和目录结构。
   - **将逻辑文件系统映射到物理次级存储设备的算法和数据结构**。
2. **文件控制块**：存储有关文件的信息的存储结构。
3. **设备驱动程序**：控制物理设备。
4. **文件系统组织成层**：这有助于管理和优化存储和检索操作。

总的来说，文件是存储在磁盘等次级存储设备上的逻辑存储单位，文件系统提供了有效的方式来组织、存储、检索和管理这些文件。文件系统的设计要考虑用户界面、存储映射算法和数据结构、以及文件和设备管理的不同层次。

### Layered File System

1. **应用程序层**（application programs）：
   - 系统调用用于文件操作。
2. **逻辑文件系统层**（logical file system）：
   - 管理元数据信息。
   - 管理目录结构。
   - 通过文件控制块（FCB，例如索引节点inodes）维护文件结构。
   - 负责保护和安全性。
3. **文件组织模块层**（file-organization module）：
   - 理解文件、逻辑地址和物理块。
   - 将逻辑块地址转换为物理块地址。
   - 空闲空间管理器，磁盘分配。
4. **基本文件系统层**（basic file system）：
   - 向适当的设备驱动程序发出通用命令来读写磁盘上的物理块。
   - 管理内存缓冲区和缓存（分配、释放、替换），例如I/O缓冲区、目录/数据的磁盘缓存。
5. **I/O控制层**（I/O control）：
   - 设备驱动程序和中断处理程序。
   - 在主内存和磁盘系统之间传输信息。
   - 将如“读取驱动器1，柱面72，磨道2，扇区10”的命令转换为内存位置1060的低级硬件特定命令。
6. **设备层**（devices）：
   - 这一层与物理硬件直接交互。

### File Systems

在操作系统中，存在多种文件系统，每种都有自己的格式：

1. **CD-ROM使用ISO 9660格式**：这是一个由制造商共同商定的标准格式。
2. **Unix系统通常使用UFS（Unix File System）**：它基于伯克利快速文件系统（Berkeley FFS）。
3. **Windows支持多种文件系统**：
   - **FAT（File Allocation Table）**：较老的文件系统，曾广泛用于早期Windows版本和可移动存储设备。
   - **FAT32**：FAT的扩展版本，支持更大的磁盘和文件尺寸。
   - **NTFS（New Technology File System）**：Windows的现代文件系统，提供安全性、文件恢复和大文件支持等特性。
   - 此外，Windows也支持软盘、CD、DVD等多种存储媒介的文件系统。
4. **Linux支持40多种类型的文件系统**：
   - **标准Linux文件系统**：扩展文件系统（extended file system），包括ext2。
   - **常用的文件系统**：ext3和ext4，它们提供了日志功能和更高的数据完整性。
   - **分布式文件系统**：专门用于分布式计算环境，如网络文件系统（NFS）等。
5. **新的文件系统仍在不断推出**：
   - **ZFS（Zettabyte File System）**：一种高容量、高性能的文件系统，提供了卓越的数据完整性保护。
   - **OpenZFS**：ZFS的一个开源版本。
   - **Google GFS（Google File System）**：用于大规模分布式计算系统的文件系统。
   - **Oracle ASM（Automatic Storage Management）**：一种数据库文件系统，用于简化数据库数据的存储管理。
   - **FUSE（Filesystem in Userspace）**：一种允许用户在用户空间中创建文件系统的接口，增加了灵活性和安全性。

## File System Implementation

### On-disk File System Structures

在磁盘上，文件系统可能包含以下部分：

1. **启动操作系统的信息**：如果操作系统存储在该磁盘上，这部分信息会告诉计算机如何从磁盘启动操作系统。

2. **块的总数**：磁盘上数据存储的基本单位，文件系统会跟踪总共有多少块。

3. **空闲块的数量和位置**：文件系统需要管理空闲块以便存储新的数据。

4. **目录结构**：包含文件和子目录的组织结构。

5. **个别文件**：具体的数据内容。

磁盘结构

1. **启动控制块（Boot Control Block）**（每个卷）：
   - 通常是卷的第一个块。
   - 在UFS中称为启动块，在NTFS中称为分区启动扇区。
2. **卷/分区控制块（Volume/Partition Control Block）**（每个卷）：
   - 包含块的详细信息、块大小、空闲块计数和空闲块指针、空闲文件控制块（FCB）计数和空闲FCB指针。
   - 在UFS中称为超级块，在NTFS中是主文件表（Master File Table）的一部分。
3. **目录结构**（每个文件系统）：
   - 在UFS中包含文件名和关联的inode编号。
   - 在NTFS中包含在主文件表中。
4. **文件控制块（FCB）**（每个文件）：
   - 包含关于文件的信息的存储结构，包括所有权、权限和文件内容的位置。
   - 在UFS中称为inode，在NTFS中也是主文件表（作为关系数据库）的一部分。

以上结构确保了文件系统能够有效地管理和定位磁盘上的数据，同时也保证了数据的安全和可访问性。每种文件系统（如UFS、NTFS）都有其特定的实现方式和数据结构。

### In-Memory File System Structures

在内存中的文件系统结构用于：
1. **文件系统管理**：这包括管理文件系统的挂载、目录结构、文件的打开和关闭等。
2. **通过缓存改善性能**：数据缓存可以减少对次级存储（如硬盘）的访问次数，从而提高系统性能。

### 内存中的结构

1. **内存中的挂载表（In-memory mount table）**：
   - 存储文件系统的挂载信息、挂载点、文件系统类型等。
2. **内存中的目录结构缓存**：
   - 加速目录访问和查找操作。
3. **系统范围的打开文件表（System-wide open-file table）**（系统中只有一张表）：
   - 包含每个打开文件的文件控制块（FCB）的副本。
   - 每个打开的文件有一个条目。
4. **每个进程的打开文件表（Per-process open-file table）**（每个进程一张表）：
   - 包含指向系统范围打开文件表中相应条目的指针。
   - 每个由该进程打开的文件有一个条目。
5. **缓冲区**：
   - 存放来自次级存储的数据块。

### Partitions and Mounting

分区与挂载是操作系统管理磁盘存储的基本概念。

分区

- 一个磁盘可以被分成多个分区，或者一个分区可以跨越多个磁盘。
- 每个分区可以是：
  - **“原始”（raw）**：不包含文件系统，只是一系列的块。
  - **“已格式化”（cooked）**：包含文件系统。

启动信息

- 启动信息可以存储在一个单独的分区中，它有自己的格式，并作为一个镜像加载到内存中，在预定义的位置开始执行。

引导加载程序（Boot loader）

- 知道足够的文件系统结构信息，能够找到并加载内核并开始执行。
- 理解多个文件系统和多个操作系统可以占用启动空间。

根分区

- 在启动时挂载的根分区，包含操作系统内核和可能的其他系统文件。

其他分区

- 其他分区可以在启动时自动挂载，或者稍后手动挂载。

挂载时检查

- 在挂载时，会检查文件系统的一致性。
  - 通过请求设备驱动程序读取目录并验证目录是否具有预期的格式。
  - 检查所有元数据是否正确。
    - 如果不正确，则修复后重试。
    - 如果正确，则添加到挂载表中，允许访问。

挂载表（Mount table）

- 包含已挂载文件系统的信息。

分区允许操作系统将磁盘空间划分为独立的区域，每个区域可以独立管理和挂载。挂载是操作系统识别和准备访问文件系统的过程。通过挂载表，系统可以跟踪所有已挂载的文件系统及其相关信息。这些概念对于操作系统有效管理存储和确保数据的完整性至关重要。

### Virtual File Systems

现代操作系统需要同时支持多种类型的文件系统。这是如何实现的，以及用户如何在不同类型的文件系统之间无缝切换？

虚拟文件系统（Virtual File System, VFS）

1. **支持多种文件系统**：
   - 操作系统必须能够支持多种不同的文件系统类型，包括网络文件系统。

2. **集成到目录结构中**：
   - 操作系统如何允许多种类型的文件系统被集成到一个目录结构中？

3. **用户无缝切换**：
   - 用户如何在文件系统空间中无缝地在不同文件系统类型之间移动？

VFS的实现方法

- 大多数操作系统（包括Unix）使用面向对象的技术来实现文件系统，这就是VFS。

VFS的功能

1. **允许不同的文件系统类型在同一个结构内实现**：
   - 这包括本地文件系统和网络文件系统。

2. **简化、组织和模块化实现**：
   - 通过数据结构和过程来隔离基本的系统调用功能与实现细节。

VFS如何工作

1. **将文件系统通用操作与实现细节分离**：
   - 实现可以是众多文件系统类型之一，或者是网络文件系统。

2. **实现了节点（vnodes）**：
   - 节点持有索引节点（inodes）或网络文件的详细信息。

3. **将操作分派给适当的文件系统实现例程**：
   - 这样用户通过相同的系统调用接口（API）就可以访问不同类型的文件系统。

4. **API针对的是VFS接口**：
   - 而不是任何特定类型的文件系统。

综上所述，VFS提供了一个抽象层，使得操作系统可以通过一个统一的接口与多种不同的文件系统交互。这样，无论用户正在访问的是本地文件系统、外部存储设备上的文件系统，还是网络文件系统，体验都是一致的。VFS的设计允许操作系统开发者在不改变用户界面的情况下，增加对新文件系统类型的支持。

## Directory Implementation

在文件系统中，文件名通常与它们数据块的指针关联，这样的结构可以用多种方式组织：

线性列表

- **优点**：编程简单。
- **缺点**：执行时间消耗大，因为每次搜索都需要遍历整个列表。
  - **线性搜索时间**：查找文件时可能需要遍历整个文件列表，这在文件数量很多时效率低下。

排序列表

- 通过对文件名列表排序，可以使用二分搜索，这样可以减少平均搜索时间。

平衡树

- 平衡树（如AVL树或红黑树）可以进一步优化搜索时间，因为它们保证了在最坏的情况下仍然具有较好的搜索效率。

哈希表

- 使用哈希数据结构的线性列表可以减少目录搜索时间。
- **碰撞问题**：两个文件名可能映射到同一哈希位置（哈希冲突）。
  - **链式溢出**：一种解决哈希冲突的方法，即在冲突发生时使用链表将冲突的元素连接起来。
- **困难**：
  - **固定大小**：哈希表的大小通常是固定的，这可能限制了文件系统的扩展性。
  - **哈希函数选择**：一个好的哈希函数应该减少冲突，同时均匀地分布数据。选择或设计一个适合文件系统需求的哈希函数可能具有挑战性。

## Allocation Methods

### Contiguous Allocation

- 将一组连续的磁盘块一次性分配给文件。
- 记录文件**起始位置**和**长度**。
- 它支持**顺序访问和直接访问**。
- 优势
  - **读写性能高**：由于数据块是连续的，读取文件时磁头移动最小，可以快速连续地读写数据。
  - **管理简单**：文件系统不需要复杂的算法来跟踪文件的各个部分，因为它们总是在一起的。
  - **不会产生外部碎片**：每个文件保存为一连串连续的块，因此不会在文件之间留下未使用的空间。
- 逻辑地址转物理地址
  - 假设文件开始于磁盘上的块号 `B`，并且每个块有 `S` 个字节。如果你想访问文件中的逻辑地址 `L`（例如，文件的第 `L` 个字节），你可以使用以下步骤来找到对应的物理地址：
    1. 计算逻辑地址 `L` 所在的块号：`BlockNum = L / S`。
    2. 计算逻辑地址 `L` 在其块内的偏移量：`Offset = L % S`。
    3. 然后，物理块号就是 `PhysicalBlock = B + BlockNum`。
    4. 物理地址就是 `PhysicalBlock` 块的起始地址加上 `Offset`。


<img src="https://picture2023-1309715649.cos.ap-beijing.myqcloud.com/img/image-20231230174756505.png" alt="image-20231230174756505" style="zoom:50%;" />

### Linked Allocation

- 链接分配是一种基于单个块的分配方式，每个文件都是一组散布在磁盘上的磁盘块的链表。
- 目录包含**第一个和最后一个块的指针**，每个块包含指向链表中**下一个块的指针**。
- 没有外部碎片化，任何空闲块都可以用于满足请求。
- 缺点是：没有随机访问，空间用于指针，可靠性较差。
- 访问第n块逻辑块时需要依次读$0-(n-1)$块，即$n-1$次磁盘IO
- 逻辑地址转物理地址
  - 假设你要访问文件的第 `L` 字节，这里的 `L` 是文件内的逻辑地址：
    1. **确定起始块**：从文件的目录项中获取指向文件第一个数据块的指针。
    2. **计算块号**：确定 `L` 所在的数据块。这需要知道每个数据块的大小 `S`（不包括存储下一个块指针的空间）。计算逻辑地址 `L` 所在的数据块编号为 `BlockNum = L / S`。
    3. **遍历数据块链**：从文件的第一个数据块开始，遵循每个块中的指针，直到到达第 `BlockNum` 个块。
    4. **计算块内偏移量**：确定 `L` 在找到的数据块内的位置，即块内偏移量 `Offset = L % S`。
    5. **定位物理地址**：使用块号和块内偏移量来确定数据的物理地址。

<img src="https://picture2023-1309715649.cos.ap-beijing.myqcloud.com/img/image-20231230174907377.png" alt="image-20231230174907377" style="zoom:50%;" />

### Indexed Allocation

- 每个文件都有自己的索引块，索引块是一个磁盘块地址的数组。
- 目录包含**索引块的块号**。
- 索引块可以避免外部碎片化，并实现文件的随机访问。
- 逻辑地址转物理地址
  - 假设文件最大大小为256KB，块大小为1KB，逻辑地址为 `LA`：
  - 一级索引分配
    1. **计算逻辑块号和块内偏移**：
       - $Q = \frac{LA}{1024}$：确定逻辑地址 `LA` 所在的数据块编号。
       - $R = LA \mod 1024$：确定 `LA` 在其数据块中的偏移量。

    2. **在索引表中找到相应的数据块**：
       - 使用Q作为索引，在索引块中找到指向实际数据块的指针。
       - 该指针指向的是文件中第Q个块的物理位置。
  - 二级索引分配
    1. **第一级索引块号 \( Q1 \)** 和 **第一级块内偏移 \( R1 \)**：
         - $Q1 = \frac{LA}{1024}$ 
         - $Q2 = \frac{Q1}{256}$ ：第二级索引块序号。
         - $R2 = Q1 \mod 256$：第二级索引块内偏移。
    2. 使用 \( Q2 \) 在外索引块中找到内索引块的物理块号；然后使用 \( R2 \) 在该内索引块中找到实际数据块的物理块号。

<img src="https://picture2023-1309715649.cos.ap-beijing.myqcloud.com/img/image-20231230180042034.png" alt="image-20231230180042034" style="zoom:50%;" />

### Performance

文件访问方式的选择取决于文件访问类型。

对于连续访问，索引块和数据块的连续分配方式比较适合。而对于链接访问，索引块和数据块的链接分配方式更适合。

在文件创建时声明访问类型，可以选择连续分配或链接分配。索引分配方式更复杂，需要根据索引结构、文件大小以及所需块的位置来决定。

单块访问可能需要2次I/O操作来读取索引块，然后1次操作读取数据块。或者需要3次I/O操作来读取2次索引块，然后1次操作读取数据块。群集可以提高吞吐量，减少CPU开销，将连续分配与索引分配结合使用，对于小文件(最多3-4个块)使用连续分配，如果文件变得很大，则自动切换到索引分配。

## Free-Space Management

### Bit map / Bit vector 

![image-20231230181225908](https://picture2023-1309715649.cos.ap-beijing.myqcloud.com/img/image-20231230181225908.png)

![image-20231230181249096](https://picture2023-1309715649.cos.ap-beijing.myqcloud.com/img/image-20231230181249096.png)

### Linked list 

![image-20231230181336671](https://picture2023-1309715649.cos.ap-beijing.myqcloud.com/img/image-20231230181336671.png)

### Grouping 

![image-20231230181440971](https://picture2023-1309715649.cos.ap-beijing.myqcloud.com/img/image-20231230181440971.png)

### Counting

![image-20231230181458449](https://picture2023-1309715649.cos.ap-beijing.myqcloud.com/img/image-20231230181458449.png)
